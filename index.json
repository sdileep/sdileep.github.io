[{"categories":["Infrastructure"],"content":"This article describes how to structure a repository to maintain multi-environment, multi-region infrastructure in AWS using Terraform.","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"In one of my recent engagements, I had to work out an approach to manage AWS infrastructure across multiple regions, and for various environments, using Terraform. As any sane copy-paste-tweak developer would, I did â€œgoogleâ€ for inspiration but ended up finding content that solved partially, either only for multi-environment or multi-region scenarios, or wasnâ€™t thought through (for example, no isolation of state between regions). For anyone in a similar need, hereâ€™s something to build upon. ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:0:0","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"Prerequisites An understanding of Terraform and the concepts of Modules, Backends, Workspaces, Remote State \u0026 AWS provider would be required to make sense of the content in this post: The following tools would be required to experiment with the provided sample code : AWS Command Line Interface with access to AWS configured Terraform ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:1:0","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"What do we have to play with? ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:2:0","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"Module Terraformâ€™s module system helps us create configurable infrastructure templates that could be reused across various environments (product-a deployed to development/production) or across various products (standard s3/DynamoDB/SNS/etc templates) ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:2:1","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"Backend Terraformâ€™s backend configuration for AWS s3 remote state uses the following configuration variables to organize infrastructure state: bucket: name of the s3 bucket where state would be stored workspace_key_prefix: custom prefix on state file path workspace: name of the workspace key: state file name In s3, state file could then be located at \u003cbucket\u003e/\u003cworkspace_key_prefix\u003e/\u003cworkspace\u003e/\u003ckey\u003e. If we substitute workspace with ap-southeast-1 or ap-southeast-2, if we substitute the variables workspace_key_prefix with product-a and key with terraform.tfstate, we end up with state files stored as: bucket â””â”€â”€product-a â”œâ”€â”€ap-southeast-1 â”‚ â””â”€â”€ terraform.tfstate â””â”€â”€ap-southeast-2 â””â”€â”€ terraform.tfstate This sets up grouping infrastructure states at a product/project level while establishing isolation between deployments to different regions while storing all those states conveniently in one place. ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:2:2","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"Approach Using the terraform module and backend systems, the infrastructure-as-source code repository layout \u0026 Terraform backend configuration snippet described in the section provides us with a way to: establish a structure in which common or a product/projectâ€™s infrastructure is templatised for reuse across various enviroments fine tune product/projectâ€™s infrastructure at an environment level while even adding environment specific infrastructure for those non-ideal cases maintain state at a region level so that we could have better isolation, canary deploy, etc., Source Layout â”œâ”€â”€ environments â”‚ â”œâ”€â”€ development â”‚ | â”œâ”€â”€ ap-southeast-1.tfvars â”‚ | â”œâ”€â”€ ap-southeast-2.tfvars â”‚ | â”œâ”€â”€ variables.tf â”‚ | â”œâ”€â”€ main.tf â”‚ | â”œâ”€â”€ provider.tf â”‚ | â”œâ”€â”€ terraform.tf â”‚ | â””â”€â”€ terraform.tfvars â”‚ â”œâ”€â”€ test â”‚ | â”œâ”€â”€ ap-southeast-1.tfvars â”‚ | â”œâ”€â”€ ap-southeast-2.tfvars â”‚ | â””â”€â”€ ... â”‚ â”œâ”€â”€ stage â”‚ | â”œâ”€â”€ ap-southeast-1.tfvars â”‚ | â””â”€â”€ ... â”‚ â””â”€â”€ production â”‚ | â””â”€â”€ ... â””â”€â”€ modules â”œâ”€â”€ aws-s3 â”‚ â”œâ”€â”€ main.tf â”‚ â”œâ”€â”€ provider.tf â”‚ â””â”€â”€ variables.tf â”œâ”€â”€ product-a â”‚ â”œâ”€â”€ main.tf â”‚ â”œâ”€â”€ provider.tf â”‚ â””â”€â”€ variables.tf â””â”€â”€ sub-system-x â”œâ”€â”€ main.tf â”œâ”€â”€ provider.tf â””â”€â”€ variables.tf environments: folder to isolate various environment (development/test/stage/production) specific configuration. This also helps with flexibility of maintaining environment specific infrastructure for those, common, non-ideal scenarios. modules: folder to host reusable resource sets grouped at product/project or at a sub-system or common infrastructure components level. This folder doesnâ€™t have to exist in the same repository - it does here as an example and might very well serve the purpose of more than handful of usecases. Region specific configurations are managed through their respective \u003cworkpace\u003e.tfvars file. For example, environments/development/ap-southeast-2.tfvars file for ap-southeast-2 region in development environment. Also, terraform.tfvars file found inside development/test/stage/production folder under environments could be used to set common configuration for a given environment, across all regions. Backend Configuration terraform { required_version = \"~\u003e 0.12.6\" backend \"s3\" { bucket = \"terraform-state-bucket\" dynamodb_table = \"terraform-state-lock-table\" encrypt = true key = \"terraform.tfstate\" region = \"ap-southeast-2\" workspace_key_prefix = \"product-a\" } } Note : The configuration described in this post and the included sample presume state bucket per environment. But, if the need is to store state from all environments in a common bucket, we could update workspace_key_prefix value to include environment in it. For example, with product-a/development or product-a/production, we end up with state under following path in s3: bucket â””â”€â”€product-a â”œâ”€â”€development â”‚ â”œâ”€â”€ap-southeast-1 â”‚ â”‚ â””â”€â”€ terraform.tfstate â”‚ â””â”€â”€ap-southeast-2 â”‚ â””â”€â”€ terraform.tfstate â””â”€â”€production â”œâ”€â”€ap-southeast-1 â”‚ â””â”€â”€ terraform.tfstate â””â”€â”€ap-southeast-2 â””â”€â”€ terraform.tfstate ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:3:0","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"Repository Source for a sample setup could be found at here. ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:4:0","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":["Infrastructure"],"content":"Working with the setup Navigate to the environment folder, development for example, on the terminal. Note: Working configuration to access AWS environment is presumed Initialize terraform To get started, first initialize your local terraform state information terraform init List out the available workspaces terraform workspace list Create a new workspace (if it doesnâ€™t exist already) #terraform workspace new \u003cworkspace-name\u003e terraform workspace new ap-southeast-2 Select a workspace #terraform workspace select \u003cworkspace-name\u003e terraform workspace select ap-southeast-2 Plan \u0026 apply changes #terraform plan -var-file=\u003cworkspace-name\u003e.tfvars #terraform apply -var-file=\u003cworkspace-name\u003e.tfvars terraform plan -var-file=ap-southeast-2.tfvars terraform apply -var-file=ap-southeast-2.tfvars Repeat for other regions For ap-southeast-1 region: terraform workspace new ap-southeast-1 terraform workspace select ap-southeast-1 terraform plan -var-file=ap-southeast-1.tfvars terraform apply -var-file=ap-southeast-1.tfvars Hopefully, this note helps a mate out! ","date":"2020-01-02","objectID":"/terraform-setup-multi-environment-region/:5:0","tags":["Devops","Terraform","AWS"],"title":"Maintain multi-environment, multi-region infrastructure on AWS using Terraform","uri":"/terraform-setup-multi-environment-region/"},{"categories":null,"content":"Hmmâ€¦!!! ğŸ¤” ","date":"2019-08-02","objectID":"/about/:0:0","tags":null,"title":"About","uri":"/about/"}]